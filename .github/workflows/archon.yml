name: archon

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  archon:
    if: |
      contains(github.event.comment.body, '/archon') ||
      startsWith(github.event.comment.body, '/archon')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: read
      issues: read
      comments: write
    steps:
      - name: Manual git clone with error reporting
        shell: bash
        run: |
          set -x
          mkdir -p /tmp/repo
          cd /tmp/repo
          git clone --depth=1 --no-checkout https://github.com/${{ github.repository }}.git . 2>&1
          git checkout HEAD 2>&1 || { echo "Checkout failed, trying sparse-checkout disable"; git config core.sparseCheckout false; git checkout HEAD; }
          ls -la | head -20

      - name: Copy to workspace
        shell: bash
        run: |
          cp -r /tmp/repo "$GITHUB_WORKSPACE"
          ls -la "$GITHUB_WORKSPACE"

      - name: Run archon
        uses: ./github
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          model: openrouter/deepseek/deepseek-v3-base:free
